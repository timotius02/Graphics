"use strict";function createIdentity(){return[[1,0,0,0],[0,1,0,0],[0,0,1,0],[0,0,0,1]]}function combine(a,b){if(a.length!==b.length)throw"error: matrices does not have same height";var c=0;return a.map(function(a){return a.concat(b[c++])})}function matrixMult(a,b){if(a[0].length!==b.length)throw"error: matrices cannot be multiplied";for(var c=[],d=0;d<a.length;d++){c[d]=[];for(var e=0;e<b[0].length;e++){for(var f=0,g=0;g<a[0].length;g++)f+=a[d][g]*b[g][e];c[d][e]=f}}return c}function matrixPrint(a){for(var b=0;b<a.length;b++){var c=a[b].join(" ");console.log(c)}}function uploadCoordinates(a){var b=a.uploadfile.value,c=new FileReader;c.readAsText(b),a.coordinates.value=c.result}function theCulling(a,b,c){var d,e=[],f=[],g=[],h=[],i=[],j=[],k=[],l=[[],[],[],[]];if("p"===b)for(var m=0;m<a[0].length;m+=3)e=[a[0][m],a[1][m],a[2][m],a[3][m]],f=[a[0][m+1],a[1][m+1],a[2][m+1],a[3][m+1]],g=[a[0][m+2],a[1][m+2],a[2][m+2],a[3][m+2]],h=[e[0]-f[0],e[1]-f[1],e[2]-f[2]],i=[g[0]-f[0],g[1]-f[1],g[2]-f[2]],k=[h[1]*i[2]-h[2]*i[1],h[2]*i[0]-h[0]*i[2],h[0]*i[1]-h[1]*i[0]],k[2]<0&&(l=combine(l,e),l=combine(l,f),l=combine(l,g));else for(var m=0;m<a[0].length;m+=3){e=[a[0][m],a[1][m],a[2][m],1],f=[a[0][m+1],a[1][m+1],a[2][m+1],1],g=[a[0][m+2],a[1][m+2],a[2][m+2],1],h=[f[0]-e[0],f[1]-e[1],f[2]-e[2]],i=[g[0]-f[0],g[1]-f[1],g[2]-f[2]],j=[e[0]-c[0],e[1]-c[1],e[2]-c[2]];var n=h[1]*i[2]-h[2]*i[1],o=h[2]*i[0]-h[0]*i[2],p=h[0]*i[1]-h[1]*i[0];k=[n,o,p],d=j[0]*k[0]+j[1]*k[1]+j[2]*k[2],0>d&&(l=combine(l,e),l=combine(l,f),l=combine(l,g))}return l}function renderCyclops(a,b){for(var c,d,e,f=b[0],g=b[1],h=b[2],i=0;i<a[0].length;i++)c=a[0][i],d=a[1][i],e=a[2][i],a[0][i]=f-h*(f-c)/(h-e),a[1][i]=g-h*(g-d)/(h-e),a[2][i]=0}function renderStereo(a,b,c){var d=a;renderCyclops(a,b),renderCyclops(d,c),a=combine(a,d)}function drawTriangles(a,b){for(var c=0;c<a[0].length;c+=3){var d=convertScreen(a[0][c],"x"),e=-convertScreen(a[1][c],"y"),f=convertScreen(a[0][c+1],"x"),g=-convertScreen(a[1][c+1],"y"),h=convertScreen(a[0][c+2],"x"),i=-convertScreen(a[1][c+2],"y");b.beginPath(),b.moveTo(d,e),b.lineTo(f,g),b.lineTo(h,i),b.lineTo(d,e),b.strokeStyle="#000000",b.stroke()}}function convertScreen(a,b){var c,d=0,e=-canvas.height+1,f=canvas.width-1,g=0;return"x"===b?c=(f-d)/(xRight-xLeft)*(a-xLeft)+d:"y"===b&&(c=(g-e)/(yTop-yBottom)*(a-yBottom)+e),c}function interpretImport(a){var b=a.split("  "),c=0,d=[[],[],[],[]];switch(b[0]){case"":1===curFrame&&(console.log(b.length),console.log(a));break;case"#":break;default:if(1===b.length)c=parseInt(b[0]);else{var e=[parseFloat(b[0]),parseFloat(b[1]),parseFloat(b[2]),1],f=[parseFloat(b[3]),parseFloat(b[4]),parseFloat(b[5]),1],g=[parseFloat(b[6]),parseFloat(b[7]),parseFloat(b[8]),1];d=combine(d,e),d=combine(d,f),d=combine(d,g)}}return d}function importFiles(a,b,c){for(var d=[[],[],[],[]],e=b;c>e;e++){var f=interpretImport(a[e]);d=combine(d,f)}return d}function interpret(a){var b=a.split(" ");switch(b[0]){case"\n":break;case"end":break;case"#":break;case"frames":numFrames=b[2];break;case"identity":transformation=createIdentity();break;case"screen":xLeft=parseFloat(b[1]),yBottom=parseFloat(b[2]),xRight=parseFloat(b[3]),yTop=parseFloat(b[4]);break;case"pixels":canvas.width=b[1],canvas.height=b[2];break;case"vary":if(1===curFrame){var c=(parseFloat(b[3])-parseFloat(b[2]))/(parseFloat(b[5])-parseFloat(b[4])),d={name:b[1],currVal:parseFloat(b[2]),increment:c,startFrame:parseInt(b[4]),endFrame:parseInt(b[5]),update:function(){this.currVal+=this.increment}};variables.push(d)}break;case"color":red=parseInt(b[1]),green=parseInt(b[2]),blue=parseInt(b[3]);break;case"save":var e={name:b[1],matrix:transformation};saves.push(e);break;case"restore":for(var e,f=0;f<saves.length;f++)if(saves[f].name===b[1])e=saves[f].matrix;else if(f===saves.length-1)throw"error: save "+b[f]+" not found";transformation=e;break;case"import":for(var g,h=document.getElementById("imports").value,i=h.split("\n"),j=2;j<b.length;j++){var k=parseFloat(b[j]);if(isNaN(k))for(var f=0;f<variables.length;f++)if(variables[f].name===b[j]&&curFrame>=variables[f].startFrame&&curFrame<=variables[f].endFrame){b[j]=variables[f].currVal.toString();break}}for(var f=0;f<i.length;f++)if("n"===i[f].charAt(0)){var l=i[f].split(" ");if(l[1]===b[1]){for(var m=f;m<i.length;m++)"e"===i[m].charAt(0)&&(g=importFiles(i,f+1,m));break}}var n=createIdentity();n[0][0]=parseFloat(b[2]),n[1][1]=parseFloat(b[3]),n[2][2]=parseFloat(b[4]),g=matrixMult(n,g);var o=createIdentity(),p=parseFloat(b[5]);o[1][1]=Math.cos(p*Math.PI/180),o[1][2]=-Math.sin(p*Math.PI/180),o[2][1]=Math.sin(p*Math.PI/180),o[2][2]=Math.cos(p*Math.PI/180),g=matrixMult(o,g);var q=createIdentity();p=parseFloat(b[6]),q[0][0]=Math.cos(p*Math.PI/180),q[0][2]=Math.sin(p*Math.PI/180),q[2][0]=-Math.sin(p*Math.PI/180),q[2][2]=Math.cos(p*Math.PI/180),g=matrixMult(q,g);var r=createIdentity();p=parseFloat(b[7]),r[0][0]=Math.cos(p*Math.PI/180),r[0][1]=-Math.sin(p*Math.PI/180),r[1][0]=Math.sin(p*Math.PI/180),r[1][1]=Math.cos(p*Math.PI/180),g=matrixMult(r,g);var s=createIdentity();s[0][3]=parseFloat(b[8]),s[1][3]=parseFloat(b[9]),s[2][3]=parseFloat(b[10]),g=matrixMult(s,g),g=matrixMult(transformation,g),triangles=combine(triangles,g);break;case"rotate-x":var p=parseFloat(b[1]);if(isNaN(p))for(var f=0;f<variables.length;f++)if(variables[f].name===b[1]&&curFrame>=variables[f].startFrame&&curFrame<=variables[f].endFrame){p=variables[f].currVal;break}var t=createIdentity();t[1][1]=Math.cos(p*Math.PI/180),t[1][2]=-Math.sin(p*Math.PI/180),t[2][1]=Math.sin(p*Math.PI/180),t[2][2]=Math.cos(p*Math.PI/180),transformation=matrixMult(transformation,t);break;case"rotate-y":var p=parseFloat(b[1]);if(isNaN(p))for(var f=0;f<variables.length;f++)if(variables[f].name===b[1]&&curFrame>=variables[f].startFrame&&curFrame<=variables[f].endFrame){p=variables[f].currVal;break}var u=createIdentity();u[0][0]=Math.cos(p*Math.PI/180),u[0][2]=Math.sin(p*Math.PI/180),u[2][0]=-Math.sin(p*Math.PI/180),u[2][2]=Math.cos(p*Math.PI/180),transformation=matrixMult(transformation,u);break;case"rotate-z":var p=parseFloat(b[1]);if(isNaN(p))for(var f=0;f<variables.length;f++)if(variables[f].name===b[1]&&curFrame>=variables[f].startFrame&&curFrame<=variables[f].endFrame){p=variables[f].currVal;break}var v=createIdentity();v[0][0]=Math.cos(p*Math.PI/180),v[0][1]=-Math.sin(p*Math.PI/180),v[1][0]=Math.sin(p*Math.PI/180),v[1][1]=Math.cos(p*Math.PI/180),transformation=matrixMult(transformation,v);break;case"move":for(var w=createIdentity(),j=1;j<b.length;j++){var k=parseFloat(b[j]);if(isNaN(k))for(var f=0;f<variables.length;f++)if(variables[f].name===b[1]&&curFrame>=variables[f].startFrame&&curFrame<=variables[f].endFrame){b[j]=variables[f].currVal.toString();break}}w[0][3]=parseFloat(b[1]),w[1][3]=parseFloat(b[2]),w[2][3]=parseFloat(b[3]),transformation=matrixMult(transformation,w);break;case"scale":for(var n=createIdentity(),j=1;j<b.length;j++){var k=parseFloat(b[j]);if(isNaN(k))for(var f=0;f<variables.length;f++)if(variables[f].name===b[1]&&curFrame>=variables[f].startFrame&&curFrame<=variables[f].endFrame){b[j]=variables[f].currVal.toString();break}}n[0][0]=parseFloat(b[1]),n[1][1]=parseFloat(b[2]),n[2][2]=parseFloat(b[3]),transformation=matrixMult(transformation,n);break;case"box-t":for(var x=[[],[],[],[]],j=1;j<b.length;j++){var k=parseFloat(b[j]);if(isNaN(k))for(var f=0;f<variables.length;f++)if(variables[f].name===b[j]&&curFrame>=variables[f].startFrame&&curFrame<=variables[f].endFrame){b[j]=variables[f].currVal.toString();break}}var y=[-.5,-.5,.5,1],z=[.5,-.5,.5,1],A=[.5,.5,.5,1],B=[-.5,.5,.5,1],C=[.5,-.5,-.5,1],D=[-.5,-.5,-.5,1],E=[-.5,.5,-.5,1],F=[.5,.5,-.5,1];x=combine(x,y),x=combine(x,z),x=combine(x,A),x=combine(x,A),x=combine(x,B),x=combine(x,y),x=combine(x,z),x=combine(x,C),x=combine(x,F),x=combine(x,F),x=combine(x,A),x=combine(x,z),x=combine(x,C),x=combine(x,D),x=combine(x,E),x=combine(x,E),x=combine(x,F),x=combine(x,C),x=combine(x,D),x=combine(x,y),x=combine(x,B),x=combine(x,B),x=combine(x,E),x=combine(x,D),x=combine(x,A),x=combine(x,F),x=combine(x,E),x=combine(x,E),x=combine(x,B),x=combine(x,A),x=combine(x,D),x=combine(x,C),x=combine(x,z),x=combine(x,z),x=combine(x,y),x=combine(x,D);var n=createIdentity();n[0][0]=parseFloat(b[1]),n[1][1]=parseFloat(b[2]),n[2][2]=parseFloat(b[3]),x=matrixMult(n,x);var o=createIdentity(),p=parseFloat(b[4]);o[1][1]=Math.cos(p*Math.PI/180),o[1][2]=-Math.sin(p*Math.PI/180),o[2][1]=Math.sin(p*Math.PI/180),o[2][2]=Math.cos(p*Math.PI/180),x=matrixMult(o,x);var q=createIdentity();p=parseFloat(b[5]),q[0][0]=Math.cos(p*Math.PI/180),q[0][2]=Math.sin(p*Math.PI/180),q[2][0]=-Math.sin(p*Math.PI/180),q[2][2]=Math.cos(p*Math.PI/180),x=matrixMult(q,x);var r=createIdentity();p=parseFloat(b[6]),r[0][0]=Math.cos(p*Math.PI/180),r[0][1]=-Math.sin(p*Math.PI/180),r[1][0]=Math.sin(p*Math.PI/180),r[1][1]=Math.cos(p*Math.PI/180),x=matrixMult(r,x);var s=createIdentity();s[0][3]=parseFloat(b[7]),s[1][3]=parseFloat(b[8]),s[2][3]=parseFloat(b[9]),x=matrixMult(s,x),x=matrixMult(transformation,x),triangles=combine(triangles,x);break;case"sphere-t":for(var G=[[],[],[],[]],H=[[],[],[],[]],I=[[],[],[],[]],J=[0,0,0,1],j=1;j<b.length;j++){var k=parseFloat(b[j]);if(isNaN(k))for(var f=0;f<variables.length;f++)if(variables[f].name===b[j]&&curFrame>=variables[f].startFrame&&curFrame<=variables[f].endFrame){b[j]=variables[f].currVal.toString();break}}for(var K=0;360>K;){for(var L=0;180>=L;L+=15)J[0]=Math.sin(L*Math.PI/180)*Math.cos(K*Math.PI/180),J[1]=Math.cos(L*Math.PI/180),J[2]=Math.sin(L*Math.PI/180)*Math.sin(K*Math.PI/180),I=combine(I,J);for(K+=15,L=0;180>=L;L+=15)J[0]=Math.sin(L*Math.PI/180)*Math.cos(K*Math.PI/180),J[1]=Math.cos(L*Math.PI/180),J[2]=Math.sin(L*Math.PI/180)*Math.sin(K*Math.PI/180),H=combine(H,J);J=[H[0][0],H[1][0],H[2][0],1],G=combine(G,J),J=[H[0][1],H[1][1],H[2][1],1],G=combine(G,J),J=[I[0][1],I[1][1],I[2][1],1],G=combine(G,J);for(var j=2;j<H[0].length-1;j++)J=[I[0][j],I[1][j],I[2][j],1],G=combine(G,J),J=[I[0][j-1],I[1][j-1],I[2][j-1],1],G=combine(G,J),J=[H[0][j-1],H[1][j-1],H[2][j-1],1],G=combine(G,J),J=[H[0][j-1],H[1][j-1],H[2][j-1],1],G=combine(G,J),J=[H[0][j],H[1][j],H[2][j],1],G=combine(G,J),J=[I[0][j],I[1][j],I[2][j],1],G=combine(G,J);J=[I[0][I[0].length-1],I[1][I[0].length-1],I[2][I[0].length-1],1],G=combine(G,J),J=[I[0][I[0].length-2],I[1][I[0].length-2],I[2][I[0].length-2],1],G=combine(G,J),J=[H[0][I[0].length-2],H[1][I[0].length-2],H[2][I[0].length-2],1],G=combine(G,J),H=[[],[],[],[]],I=[[],[],[],[]]}var n=createIdentity();n[0][0]=parseFloat(b[1]),n[1][1]=parseFloat(b[2]),n[2][2]=parseFloat(b[3]),G=matrixMult(n,G);var o=createIdentity(),p=parseFloat(b[4]);o[1][1]=Math.cos(p*Math.PI/180),o[1][2]=-Math.sin(p*Math.PI/180),o[2][1]=Math.sin(p*Math.PI/180),o[2][2]=Math.cos(p*Math.PI/180),G=matrixMult(o,G);var q=createIdentity();p=parseFloat(b[5]),q[0][0]=Math.cos(p*Math.PI/180),q[0][2]=Math.sin(p*Math.PI/180),q[2][0]=-Math.sin(p*Math.PI/180),q[2][2]=Math.cos(p*Math.PI/180),G=matrixMult(q,G);var r=createIdentity();p=parseFloat(b[6]),r[0][0]=Math.cos(p*Math.PI/180),r[0][1]=-Math.sin(p*Math.PI/180),r[1][0]=Math.sin(p*Math.PI/180),r[1][1]=Math.cos(p*Math.PI/180),G=matrixMult(r,G);var s=createIdentity();s[0][3]=parseFloat(b[7]),s[1][3]=parseFloat(b[8]),s[2][3]=parseFloat(b[9]),G=matrixMult(s,G),G=matrixMult(transformation,G),triangles=combine(triangles,G);break;case"render-parallel":var M=[0,0,0],N=theCulling(triangles,"p",M);drawTriangles(N,context);break;case"render-perspective-cyclops":M=[parseFloat(b[1]),parseFloat(b[2]),parseFloat(b[3])];var N=theCulling(triangles,"c",M);renderCyclops(N,M),drawTriangles(N,context);break;case"render-perspective-stereo":var O=[parseFloat(b[1]),parseFloat(b[2]),parseFloat(b[3])],P=[parseFloat(b[4]),parseFloat(b[5]),parseFloat(b[6])],Q=theCulling(triangles,"s",O),R=theCulling(triangles,"s",P);renderCyclops(Q,O),renderCyclops(R,P),drawTriangles(Q,context),drawTriangles(R,context)}}function updateVariables(){for(var a=0;a<variables.length;a++)curFrame>=variables[a].startFrame&&curFrame<=variables[a].endFrame&&variables[a].update()}function printVariables(){for(var a=0;a<variables.length;a++)console.log(variables[a].name+" : "+variables[a].currVal)}function parseLine(a){for(var b=a.split("\n"),c=0;c<b.length;c++)interpret(b[c])}function grabText(){var a=document.getElementById("myTextArea").value;id&&clearInterval(id),continuous=document.getElementById("continuous").checked,variables=[],curFrame=1,numFrames=1,id=setInterval(function(){canvas.width=canvas.width,triangles=[[],[],[],[]],transformation=createIdentity(),saves=[],red=0,green=0,blue=0,parseLine(a),curFrame++,updateVariables(),curFrame>numFrames&&(continuous?(variables=[],curFrame=1,numFrames=1):clearInterval(id))},33)}function grabSample(){var a="# object3d commands test (corrected)\nscreen -3 -2 3 2\npixels 600 400\nrotate-y 40\nrotate-x 20\nsphere-t 1 1 1 0 0 0 1 0 0\nbox-t 1 1 1 0 0 0 -1 -0.5 -1\nrender-parallel";document.getElementById("myTextArea").value=a}function drawCopy(a){canvas.width=canvas.width;var b=[0,0,0],c=theCulling(a,"p",b);drawTriangles(c,context)}function rotate(a){var b=a.xRotate,c=createIdentity(),d=triangles;c[1][1]=Math.cos(b*Math.PI/180),c[1][2]=-Math.sin(b*Math.PI/180),c[2][1]=Math.sin(b*Math.PI/180),c[2][2]=Math.cos(b*Math.PI/180),d=matrixMult(c,d),b=a.yRotate;var e=createIdentity();e[0][0]=Math.cos(b*Math.PI/180),e[0][2]=Math.sin(b*Math.PI/180),e[2][0]=-Math.sin(b*Math.PI/180),e[2][2]=Math.cos(b*Math.PI/180),d=matrixMult(e,d),b=a.zRotate;var f=createIdentity();f[0][0]=Math.cos(b*Math.PI/180),f[0][1]=-Math.sin(b*Math.PI/180),f[1][0]=Math.sin(b*Math.PI/180),f[1][1]=Math.cos(b*Math.PI/180),d=matrixMult(f,d),drawCopy(d)}function orientationHandler(a){var b={zRotate:a.gamma,xRotate:-a.beta,yRotate:a.alpha};is_client.checked&&(socket.emit("devicerotate",b),rotate(b))}var canvas=document.getElementById("myCanvas"),button=document.getElementById("myButton"),sample=document.getElementById("sample"),context=canvas.getContext("2d"),triangles=[[],[],[],[]],transformation=createIdentity(),numFrames=1,curFrame=1,xLeft,yBottom,xRight,yTop,variables=[],red=0,green=0,blue=0,saves=[],continuous=!1,id;button.addEventListener("click",grabText,!1),sample.addEventListener("click",grabSample,!1);var socket=io();socket.on("connect",function(){socket.on("rotate",function(a){rotate(a)}),socket.on("disconnect",function(){})});var is_client=document.getElementById("is_client");window.DeviceOrientationEvent&&window.addEventListener("deviceorientation",orientationHandler,!1),window.onload=function(){if(window.File&&window.FileList&&window.FileReader){var a=document.getElementById("files");a.addEventListener("change",function(a){for(var b=a.target.files,c=(document.getElementById("result"),0);c<b.length;c++){var d=b[c],e=new FileReader;e.addEventListener("load",function(a){document.getElementById("myTextArea").value=a.target.result}),e.readAsText(d)}});var b=document.getElementById("importFiles");b.addEventListener("change",function(a){for(var b=a.target.files,c=(document.getElementById("result"),0);c<b.length;c++){var d=b[c],e=new FileReader;e.addEventListener("load",function(a){document.getElementById("imports").value+="\nname "+d.name+"\n",document.getElementById("imports").value+=a.target.result,document.getElementById("imports").value+="end\n"}),e.readAsText(d)}})}else console.log("Your browser does not support File API")};